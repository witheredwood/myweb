(function (factory) {
    if (typeof module === "object" && typeof module.exports === "object") {
        var v = factory(require, exports);
        if (v !== undefined) module.exports = v;
    }
    else if (typeof define === "function" && define.amd) {
        define(["require", "exports", "tslib", "@alicloud/mpserverless-core", "crypto-js/core", "crypto-js/hmac-md5", "./error"], factory);
    }
})(function (require, exports) {
    "use strict";
    Object.defineProperty(exports, "__esModule", { value: true });
    var tslib_1 = require("tslib");
    var mpserverless_core_1 = require("@alicloud/mpserverless-core");
    var core_1 = tslib_1.__importDefault(require("crypto-js/core"));
    var hmac_md5_1 = tslib_1.__importDefault(require("crypto-js/hmac-md5"));
    var error_1 = require("./error");
    var MPHTTPRequestEncoder = (function (_super) {
        tslib_1.__extends(MPHTTPRequestEncoder, _super);
        function MPHTTPRequestEncoder(endpoint, spaceId) {
            var _this = _super.call(this, endpoint) || this;
            _this.spaceId = spaceId;
            _this.prefix = mpserverless_core_1.PREFIX.CLIENT;
            _this.serviceHeaders = {};
            _this.setBodyField({
                spaceId: spaceId,
            });
            return _this;
        }
        MPHTTPRequestEncoder.prototype.sign = function (clientSecret) {
            var _a = this.body, spaceId = _a.spaceId, method = _a.method, params = _a.params, token = _a.token, userId = _a.userId;
            var timestamp = Date.now();
            this.setBodyField({
                timestamp: timestamp,
            });
            var signString = '';
            var signObject = {
                spaceId: spaceId,
                timestamp: timestamp,
                method: method,
                params: JSON.stringify(params),
                token: token,
                userId: userId,
            };
            Object.keys(signObject).sort().forEach(function (key) {
                if (signObject[key]) {
                    signString = signString + "&" + key + "=" + signObject[key];
                }
            });
            signString = signString.slice(1);
            var sign = hmac_md5_1.default(signString, clientSecret).toString(core_1.default.enc.Hex);
            this.setServerlessHeaders({ sign: sign });
        };
        MPHTTPRequestEncoder.prototype.encodeAsHTTPRequestObject = function (additionalObject) {
            if (this.body.params) {
                this.body.params = JSON.stringify(this.body.params);
            }
            return tslib_1.__assign({ url: this.url, data: this.body, method: this.method, headers: this.headers, dataType: 'json' }, additionalObject);
        };
        MPHTTPRequestEncoder.prototype.clone = function () {
            var encoder = new MPHTTPRequestEncoder(this.endpoint, this.spaceId);
            encoder.setBodyField(this.body);
            encoder.setBaseHeaders(this.baseHeaders);
            encoder.setServerlessHeaders(this.serverlessHeaders);
            return encoder;
        };
        return MPHTTPRequestEncoder;
    }(mpserverless_core_1.HTTPRequestEncoder));
    exports.MPHTTPRequestEncoder = MPHTTPRequestEncoder;
    var MPHTTPResponseDecoder = (function (_super) {
        tslib_1.__extends(MPHTTPResponseDecoder, _super);
        function MPHTTPResponseDecoder() {
            var _this = _super !== null && _super.apply(this, arguments) || this;
            _this.ERROR_CODES = [11, 12, 13, 14, 19, 20];
            return _this;
        }
        MPHTTPResponseDecoder.prototype.setStatusAndBody = function (status, body) {
            _super.prototype.setStatusAndBody.call(this, status, body);
            if (this.ERROR_CODES.indexOf(status) >= 0) {
                this._error = error_1.bizError.InterfaceRequestError("\u9519\u8BEF\u7801 " + status.toString() + ", \u8BF7\u53C2\u8003\u5BF9\u5E94\u5F00\u653E\u5E73\u53F0\u6587\u6863\u6392\u67E5\u95EE\u9898");
            }
        };
        MPHTTPResponseDecoder.prototype.decode = function (res) {
            this.setHeaders(res.headers || {});
            var body = res.data || res.body;
            if (typeof body === 'string') {
                body = JSON.parse(body);
            }
            if (body && body.data) {
                if (Number(body.data.affectedDocs) === body.data.affectedDocs) {
                    body = Object.assign({}, body, tslib_1.__assign({}, body.data));
                }
                else if (Object.prototype.toString.call(body.data) === '[object Object]') {
                    body.result = Object.assign({}, body.data);
                }
                else if (Object.prototype.toString.call(body.data) === '[object Array]') {
                    body.result = body.data.slice(0);
                }
                else {
                    body.result = body.data;
                }
                delete body.data;
            }
            if (/^request:fail+/.test(res.errMsg)) {
                this.setErrorMessage(res.errMsg);
                return _super.prototype.decode.call(this);
            }
            var responseErrorCode = parseInt(res.error, 10);
            if (responseErrorCode) {
                this.setStatusAndBody(responseErrorCode, body);
                return _super.prototype.decode.call(this);
            }
            var responseErrorMessage = res.err;
            if (responseErrorMessage) {
                this.setErrorMessage(responseErrorMessage);
                return _super.prototype.decode.call(this);
            }
            if (res instanceof Error) {
                this.setErrorObject(res);
                return _super.prototype.decode.call(this);
            }
            if (body && typeof body.error === 'object') {
                this.setErrorObject(body.error);
                return _super.prototype.decode.call(this);
            }
            var responseStatusCode = parseInt(res.status || res.statusCode, 10);
            if (responseStatusCode) {
                this.setStatusAndBody(responseStatusCode, body);
                return _super.prototype.decode.call(this);
            }
            this.setStatusAndBody(200, res);
            return _super.prototype.decode.call(this);
        };
        return MPHTTPResponseDecoder;
    }(mpserverless_core_1.HTTPResponseDecoder));
    exports.MPHTTPResponseDecoder = MPHTTPResponseDecoder;
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29kZWMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvY29kZWMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7O0lBQUEsaUVBT3FDO0lBQ3JDLGdFQUFvQztJQUNwQyx3RUFBeUM7SUFDekMsaUNBQW1DO0lBV25DO1FBQTBDLGdEQUFrQjtRQVMxRCw4QkFBWSxRQUFnQixFQUFZLE9BQWU7WUFBdkQsWUFDRSxrQkFBTSxRQUFRLENBQUMsU0FLaEI7WUFOdUMsYUFBTyxHQUFQLE9BQU8sQ0FBUTtZQVI3QyxZQUFNLEdBQUcsMEJBQU0sQ0FBQyxNQUFNLENBQUM7WUFDdkIsb0JBQWMsR0FBMEIsRUFBRSxDQUFDO1lBVW5ELEtBQUksQ0FBQyxZQUFZLENBQUM7Z0JBQ2hCLE9BQU8sU0FBQTthQUNSLENBQUMsQ0FBQzs7UUFDTCxDQUFDO1FBTU0sbUNBQUksR0FBWCxVQUFZLFlBQW9CO1lBQ3hCLElBQUEsY0FBc0QsRUFBcEQsb0JBQU8sRUFBRSxrQkFBTSxFQUFFLGtCQUFNLEVBQUUsZ0JBQUssRUFBRSxrQkFBb0IsQ0FBQztZQUM3RCxJQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7WUFDN0IsSUFBSSxDQUFDLFlBQVksQ0FBQztnQkFDaEIsU0FBUyxXQUFBO2FBQ1YsQ0FBQyxDQUFDO1lBQ0gsSUFBSSxVQUFVLEdBQUcsRUFBRSxDQUFDO1lBQ3BCLElBQU0sVUFBVSxHQUFHO2dCQUNqQixPQUFPLFNBQUE7Z0JBQ1AsU0FBUyxXQUFBO2dCQUNULE1BQU0sUUFBQTtnQkFDTixNQUFNLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUM7Z0JBQzlCLEtBQUssT0FBQTtnQkFDTCxNQUFNLFFBQUE7YUFDUCxDQUFDO1lBQ0YsTUFBTSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxPQUFPLENBQUMsVUFBQSxHQUFHO2dCQUN4QyxJQUFJLFVBQVUsQ0FB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